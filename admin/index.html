<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>لوحة الإدارة – Khotwa</title>
  <meta name="robots" content="noindex,nofollow"/>

  <style>
    /* ===== تصميم أساسي منظم ===== */
    :root{
      --bg:#ffffff; --surface:#ffffff; --text:#0f172a; --muted:#667085; --ring:#e5e7eb;
      --primary:#1e40af; --primary-600:#1d4ed8;
      --container: min(1160px, 94%);
      --header-h: 68px;
      --r-md: 12px; --r-lg: 16px;
      --sh: 0 8px 28px rgba(2,6,23,.06);
      --fs-100: 12px; --fs-200: 13px; --fs-300: 14px; --fs-400: 15px; --fs-500: 16px; --fs-600: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", "Dubai", Tahoma, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      line-height: 1.55;
    }
    .container{width:var(--container); margin-inline:auto}

    /* ===== رأس الصفحة ===== */
    header{
      position: sticky; inset-block-start: 0; z-index: 50;
      height: var(--header-h);
      border-bottom: 1px solid var(--ring);
      background: color-mix(in oklab, var(--surface) 90%, transparent);
      backdrop-filter: blur(8px);
    }
    .head{
      height: 100%;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: .9rem;
    }
    .brand{
      display:flex; align-items:center; gap:.65rem; font-weight:800; letter-spacing:.2px;
      font-size: var(--fs-600);
    }
    .brand img{
      inline-size: 36px; block-size: 36px; border-radius: 12px; object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .status{display:flex; align-items:center; gap:.6rem; color:var(--muted); font-size:var(--fs-300)}
    .dot{inline-size:10px; block-size:10px; border-radius:50%; background:#10b981}

    .actions{display:flex; align-items:center; gap:.5rem; flex-wrap: wrap}
    .btn{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.5rem .8rem; border-radius: 999px; font-weight:600;
      border:1px solid var(--ring); background:#fff; color:inherit; text-decoration:none;
      font-size: var(--fs-300);
    }
    .btn:is(:hover,:focus-visible){box-shadow:0 2px 10px rgba(2,6,23,.08)}
    .btn-primary{background:var(--primary); color:#fff; border-color:transparent}
    .chip{padding:.45rem .7rem; border-radius:999px; border:1px solid var(--ring); background:#fff}
    .icon{inline-size:18px; block-size:18px}

    /* شريط تنبيه أمني */
    .banner{background:#f8fafc; border-block:1px solid var(--ring)}
    .banner .bar{display:flex; align-items:center; justify-content:space-between; gap:.8rem; padding:.7rem 0; font-size:var(--fs-300)}
    .banner a{color:var(--primary); text-decoration:underline}

    /* إحصائيات */
    .stats{width:var(--container); margin:12px auto 0; display:grid; grid-template-columns:repeat(3,1fr); gap:.9rem}
    .card{
      border:1px solid var(--ring); background:#fff; border-radius: var(--r-lg);
      box-shadow: var(--sh); padding: 14px 16px; display:grid; gap:4px;
    }
    .card .label{color:var(--muted); font-size: var(--fs-300)}
    .card .value{font-weight:800; font-size: clamp(20px, 2.4vw + 10px, 28px)}

    /* غلاف تطبيق Decap */
    #nc-root{padding-block: 16px 24px}
    .cms-wrap{width:var(--container); margin-inline:auto}

    /* استجابة للموبايل */
    @media (max-width: 900px){
      :root{ --container: min(100%, 96%) }
      .brand span{display:none}
      .actions .btn{padding:.45rem .6rem}
      .stats{grid-template-columns:1fr; gap:.65rem}
    }

    /* وضع داكن تبع النظام */
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0a0f1a; --surface:#0b1220; --ring:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --sh:0 8px 26px rgba(0,0,0,.28) }
      header{background: color-mix(in oklab, var(--surface) 94%, transparent)}
      .btn, .chip, .card{background:#0f172a; border-color:var(--ring); color:var(--text)}
      .banner{background:#0c1220}
    }

    /* وصولية */
    :where(a,button,[role="button"]):focus-visible{outline:3px solid #2563eb; outline-offset:3px; border-radius:10px}
  </style>
</head>
<body>
  <!-- Header -->
  <header aria-label="الشريط العلوي">
    <div class="container head">
      <a class="brand" href="/" target="_blank" rel="noopener" aria-label="فتح الموقع">
        <img src="/assets/apple-touch-icon.png" alt="" width="36" height="36" decoding="async" loading="lazy">
        <span>Khotwa</span>
      </a>

      <div class="status">
        <span class="muted">لوحة الإدارة</span>
        <span class="dot" title="متصل" aria-hidden="true"></span>
      </div>

      <div class="actions">
        <button id="langBtn" class="chip" type="button" aria-pressed="false" aria-label="تبديل اللغة">English</button>
        <a class="btn" href="#/collections/settings/entries/site" aria-label="إعدادات">إعدادات</a>
        <a class="btn" href="#/collections/events_json/entries/events" aria-label="الفعاليات JSON">الفعاليات</a>
        <a class="btn" href="#/collections/news_json/entries/news" aria-label="الأخبار JSON">الأخبار</a>
        <a class="btn btn-primary" href="/index.html" target="_blank" rel="noopener">فتح الموقع ↗</a>
      </div>
    </div>
  </header>

  <!-- Banner -->
  <div class="banner" role="note" aria-label="تنبيه أمني">
    <div class="container bar">
      <div>ننصحك بتفعيل التحقّق بخطوتين (2FA) لحساب Netlify لحماية أفضل.</div>
      <a href="https://docs.netlify.com/manage/security/secure-netlify-access/enforce-2fa/" target="_blank" rel="noopener">كيفية تفعيل 2FA ↗</a>
    </div>
  </div>

  <!-- Stats -->
  <section class="stats" aria-label="إحصاءات المحتوى">
    <div class="card">
      <div class="label">الأخبار</div>
      <div class="value" id="stat-news">—</div>
    </div>
    <div class="card">
      <div class="label">الفعاليات القادمة</div>
      <div class="value" id="stat-events">—</div>
    </div>
    <div class="card">
      <div class="label">آخر تحديث</div>
      <div class="value" id="stat-updated">—</div>
    </div>
  </section>

  <!-- Decap CMS app (لا نعدل داخله إطلاقًا) -->
  <div class="cms-wrap">
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </div>

  <script>
    // تبديل اللغة RTL/LTR (محفوظ محليًا)
    (function(){
      const btn = document.getElementById('langBtn');
      const key = 'khotwa_admin_lang';
      const isEn = () => localStorage.getItem(key) === 'en';
      function apply(en){
        document.documentElement.lang = en ? 'en' : 'ar';
        document.documentElement.dir  = en ? 'ltr' : 'rtl';
        btn.textContent = en ? 'العربية' : 'English';
        btn.setAttribute('aria-pressed', String(en));
        localStorage.setItem(key, en ? 'en' : 'ar');
      }
      apply(isEn());
      btn.addEventListener('click', ()=> apply(!isEn()));
    })();

    // إحصائيات: قراءة news/events (مع فحص response.ok الصحيح)
    (async function(){
      const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
      const nowTxt = new Intl.DateTimeFormat('ar', { dateStyle:'medium', timeStyle:'short' }).format(new Date());
      set('stat-updated', nowTxt);

      try{
        const [nr, er] = await Promise.all([
          fetch('/data/news.json?ts=' + Date.now(),   {cache:'no-store'}),
          fetch('/data/events.json?ts=' + Date.now(), {cache:'no-store'})
        ]);
        if(!nr.ok) throw new Error('HTTP '+nr.status);
        if(!er.ok) throw new Error('HTTP '+er.status);

        const news   = await nr.json();
        const events = await er.json();
        const newsItems  = Array.isArray(news.items)   ? news.items   : [];
        const eventItems = Array.isArray(events.items) ? events.items : [];

        const today = new Date(); today.setHours(0,0,0,0);
        const upcoming = eventItems.filter(ev=>{
          const d = ev?.date ? new Date(ev.date) : null;
          return d && !isNaN(d) && d >= today;
        });

        set('stat-news',   String(newsItems.length));
        set('stat-events', String(upcoming.length));
      }catch(e){
        console.error('Stats error:', e);
        set('stat-news', '—'); set('stat-events', '—');
      }
    })();
  </script>
</body>
</html>
