<script>
/* ========== Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù€Worker (Ø®Ø·ÙˆØ© 2) ========== */
/* Ø¥Ø°Ø§ Ø¹Ø§Ù…Ù„ Cloudflare Ù…Ø±Ø¨ÙˆØ· Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙƒÙÙŠ */
const API_URL = 'https://khotwastudentcouncil.com/admin/update';

/* Ù†Ø®Ø²Ù‘Ù† ADMIN_TOKEN ÙÙŠ localStorage Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙƒÙˆÙ† Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ */
const TOKEN_KEY = 'khotwa_admin_token_v1';
let ADMIN_TOKEN = localStorage.getItem(TOKEN_KEY);
async function ensureToken(){
  if(!ADMIN_TOKEN){
    const val = prompt('Ø£Ø¯Ø®Ù„ ADMIN_TOKEN (Ù…Ù† Cloudflare Worker):');
    if(!val){ alert('Ù„Ø§Ø²Ù… ØªØ¯Ø®Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±'); throw new Error('Missing ADMIN_TOKEN'); }
    ADMIN_TOKEN = val.trim();
    localStorage.setItem(TOKEN_KEY, ADMIN_TOKEN);
  }
}
function clearToken(){
  localStorage.removeItem(TOKEN_KEY);
  ADMIN_TOKEN = null;
  toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙƒÙ†â€”Ø³Ù†Ø³Ø£Ù„Ùƒ Ø¹Ù†Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸','ok');
}

/* ========== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ========== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const toLocal=iso=>{const d=new Date(iso);d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,16);}
const fromLocal=v=>{const d=new Date(v);return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString();}
const splitTags=s=>(s||'').split(',').map(t=>t.trim()).filter(Boolean);
const cryptoId=()=>crypto.getRandomValues(new Uint32Array(4)).join('-');
function toast(msg,type=''){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;$('#toasts').appendChild(t);setTimeout(()=>t.remove(),2500);}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function load(k){try{return JSON.parse(localStorage.getItem(k)||'null')}catch{return null}}
function downloadJSON(obj,name){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1000);}
function pickJSON(cb){const inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.onchange=async()=>{const f=inp.files[0];if(!f)return;const t=await f.text();try{cb(JSON.parse(t));}catch{toast('JSON ØºÙŠØ± ØµØ§Ù„Ø­','err');}};inp.click();}

/* Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ø®Ø²Ù† Ø¹Ø¨Ø± Ø§Ù„Ù€Worker */
async function saveToRepo(path, content){
  await ensureToken();
  try{
    const res = await fetch(API_URL,{
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ADMIN_TOKEN}`,
        'Content-Type':'application/json'
      },
      body: JSON.stringify({ path, content })
    });
    if(!res.ok){
      // Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ù…Ø«Ù„Ø§Ù‹ 401 Ø£Ùˆ CORS)
      const txt = await res.text().catch(()=>res.statusText);
      if(res.status === 401){
        toast('Unauthorized: ØªØ£ÙƒØ¯ Ù…Ù† ADMIN_TOKENØŒ Ø³Ù†Ù…Ø³Ø­Ù‡ Ø§Ù„Ø¢Ù† Ù„ØªØ¹ÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„Ù‡','err');
        clearToken();
      }
      throw new Error(txt||('HTTP '+res.status));
    }
    const json = await res.json();
    toast('Ø­ÙÙØ¸ Ù„Ù„Ù…Ø®Ø²Ù† (KV) âœ”ï¸','ok');
    return json;
  }catch(err){
    console.error(err);
    toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+err.message,'err');
    throw err;
  }
}

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª ========== */
const tabs=$$('.tab'), panels=$$('[data-panel]');
tabs.forEach(b=>b.addEventListener('click',()=>{
  tabs.forEach(t=>t.setAttribute('aria-selected','false'));
  panels.forEach(p=>p.hidden=true);
  b.setAttribute('aria-selected','true');
  document.querySelector(`[data-panel="${b.dataset.tab}"]`).hidden=false;
}));

/* ========== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ========== */
const KEY_SETTINGS='khotwa_settings_v1';
let settings=load(KEY_SETTINGS)||{
  siteName:'Khotwa Student Council',
  tagline_ar:'Ù…Ø¬Ù„Ø³ Ø·Ù„Ø§Ø¨ Ø®Ø·ÙˆØ©',
  tagline_en:'Khotwa Student Council',
  description:'',
  ogImage:'',
  social:{instagram:'https://www.instagram.com/khotwa.sc/',twitter:'',facebook:'',linkedin:''},
  footer:{copyright:'Khotwa Student Council'}
};
const sF={name:$('#s_siteName'),og:$('#s_og'),tag_ar:$('#s_tag_ar'),tag_en:$('#s_tag_en'),desc:$('#s_desc'),ig:$('#s_ig'),tw:$('#s_tw'),fb:$('#s_fb'),ln:$('#s_in'),copy:$('#s_copy')};
function fillSettings(){ sF.name.value=settings.siteName||''; sF.og.value=settings.ogImage||''; sF.tag_ar.value=settings.tagline_ar||''; sF.tag_en.value=settings.tagline_en||''; sF.desc.value=settings.description||''; sF.ig.value=settings.social?.instagram||''; sF.tw.value=settings.social?.twitter||''; sF.fb.value=settings.social?.facebook||''; sF.ln.value=settings.social?.linkedin||''; sF.copy.value=settings.footer?.copyright||''; }
fillSettings();
$('#form-settings').addEventListener('submit',e=>{
  e.preventDefault();
  settings.siteName=sF.name.value.trim();
  settings.ogImage=sF.og.value.trim();
  settings.tagline_ar=sF.tag_ar.value.trim();
  settings.tagline_en=sF.tag_en.value.trim();
  settings.description=sF.desc.value.trim();
  settings.social={instagram:sF.ig.value.trim(),twitter:sF.tw.value.trim(),facebook:sF.fb.value.trim(),linkedin:sF.ln.value.trim()};
  settings.footer={copyright:sF.copy.value.trim()||'Khotwa Student Council'};
  save(KEY_SETTINGS,settings); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ âœ”ï¸','ok');
});
$('#settings-export').onclick=()=>downloadJSON(settings,'settings.json');
$('#settings-import').onclick=()=>pickJSON(obj=>{settings=obj;save(KEY_SETTINGS,settings);fillSettings();toast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ”ï¸','ok');});
$('#settings-save').onclick=()=>saveToRepo('data/settings.json',settings);

/* ========== Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ========== */
const KEY_NAV='khotwa_nav_v1';
let navItems=load(KEY_NAV)||[];
const navT=$('#nav-table tbody');
function renderNav(){
  navT.innerHTML='';
  navItems.sort((a,b)=>(a.order||0)-(b.order||0));
  if(navItems.length===0){ navT.innerHTML='<tr><td colspan="6" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</td></tr>'; return; }
  navItems.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><input value="${esc(it.ar||'')}" data-f="ar" style="width:100%"></td>
      <td><input value="${esc(it.en||'')}" data-f="en" style="width:100%"></td>
      <td><input value="${esc(it.href||'')}" data-f="href" style="width:100%"></td>
      <td><input type="checkbox" ${it.visible!==false?'checked':''} data-f="visible"></td>
      <td>
        <button class="btn" data-up>â¬†ï¸</button>
        <button class="btn" data-down>â¬‡ï¸</button>
        <button class="btn err" data-del>ğŸ—‘ï¸</button>
      </td>`;
    tr.querySelectorAll('input').forEach(inp=>{
      inp.oninput=()=>{
        const f=inp.dataset.f;
        if(f==='visible') it.visible=inp.checked;
        else it[f]=inp.value;
        save(KEY_NAV,navItems);
      };
    });
    tr.querySelector('[data-up]').onclick=()=>{ if(idx>0){ [navItems[idx-1],navItems[idx]]=[navItems[idx],navItems[idx-1]]; save(KEY_NAV,navItems); renderNav(); } };
    tr.querySelector('[data-down]').onclick=()=>{ if(idx<navItems.length-1){ [navItems[idx+1],navItems[idx]]=[navItems[idx],navItems[idx+1]]; save(KEY_NAV,navItems); renderNav(); } };
    tr.querySelector('[data-del]').onclick=()=>{ navItems=navItems.filter(x=>x!==it); save(KEY_NAV,navItems); renderNav(); };
    navT.appendChild(tr);
  });
}
renderNav();
$('#nav-add').onclick=()=>{ navItems.push({id:cryptoId(),ar:'Ø¹Ù†',en:'About',href:'/about.html',visible:true,order:navItems.length+1}); save(KEY_NAV,navItems); renderNav(); };
$('#nav-export').onclick=()=>downloadJSON(navItems,'navigation.json');
$('#nav-import').onclick=()=>pickJSON(arr=>{ if(Array.isArray(arr)){ navItems=arr; save(KEY_NAV,navItems); renderNav(); toast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ”ï¸','ok'); } else toast('Array Ù…Ø·Ù„ÙˆØ¨Ø©','err');});
$('#nav-save').onclick=()=>saveToRepo('data/navigation.json',navItems);

/* ========== Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ========== */
const KEY_NEWS='khotwa_news_v1';
let news=load(KEY_NEWS)||[];
const nForm=$('#form-news'), nSubmit=$('#n_submit'), nEditId=$('#n_edit_id'), nQ=$('#n_q'), nSort=$('#n_sort'), nT=$('#n_table tbody');
const nF={title_ar:$('#n_title_ar'),title_en:$('#n_title_en'),desc_ar:$('#n_desc_ar'),desc_en:$('#n_desc_en'),date:$('#n_date'),image:$('#n_image'),url:$('#n_url'),tags:$('#n_tags')};
nForm.addEventListener('submit',e=>{
  e.preventDefault();
  if(!nF.title_ar.value.trim()||!nF.title_en.value.trim()) return toast('Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ÙŠÙ† Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†','err');
  if(!nF.date.value) return toast('Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ù…Ø·Ù„ÙˆØ¨','err');
  const item={id:nEditId.value||cryptoId(),title:{ar:nF.title_ar.value.trim(),en:nF.title_en.value.trim()},summary:{ar:nF.desc_ar.value.trim(),en:nF.desc_en.value.trim()},date:fromLocal(nF.date.value),image:nF.image.value.trim(),url:nF.url.value.trim(),tags:splitTags(nF.tags.value)};
  const idx=news.findIndex(x=>x.id===item.id); if(idx>=0) news[idx]=item; else news.unshift(item);
  save(KEY_NEWS,news); nForm.reset(); nEditId.value=''; nSubmit.textContent='â• Ø£Ø¶Ù Ø®Ø¨Ø±'; renderNews(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”ï¸','ok');
});
nQ.addEventListener('input',renderNews); nSort.addEventListener('change',renderNews);
function renderNews(){
  nT.innerHTML='';
  let list=news.slice();
  const term=(nQ.value||'').toLowerCase();
  if(term) list=list.filter(x=>JSON.stringify(x).toLowerCase().includes(term));
  if(nSort.value==='date_asc') list.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(nSort.value==='date_desc') list.sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(nSort.value==='title_ar') list.sort((a,b)=> (a.title.ar||'').localeCompare(b.title.ar||'','ar'));
  if(nSort.value==='title_en') list.sort((a,b)=> (a.title.en||'').localeCompare(b.title.en||'','en'));
  if(list.length===0){ nT.innerHTML='<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±.</td></tr>'; return; }
  list.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div>${esc(it.title.ar)}</div><div class="muted">${esc(it.title.en)}</div></td>
      <td>${new Date(it.date).toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'})}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${esc(t)}</span>`).join('')}</td>
      <td>${it.image?`ğŸ–¼ï¸ <a href="${esc(it.image)}" target="_blank" rel="noopener">ØµÙˆØ±Ø©</a><br>`:''}${it.url?`ğŸ”— <a href="${esc(it.url)}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø·</a>`:''}</td>
      <td><button class="btn" data-edit>ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn err" data-del>Ø­Ø°Ù</button></td>`;
    tr.querySelector('[data-edit]').onclick=()=>{ nF.title_ar.value=it.title.ar; nF.title_en.value=it.title.en; nF.desc_ar.value=it.summary.ar; nF.desc_en.value=it.summary.en; nF.date.value=toLocal(it.date); nF.image.value=it.image||''; nF.url.value=it.url||''; nF.tags.value=(it.tags||[]).join(', '); nEditId.value=it.id; nSubmit.textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; window.scrollTo({top:0,behavior:'smooth'}); };
    tr.querySelector('[data-del]').onclick=()=>{ news=news.filter(x=>x.id!==it.id); save(KEY_NEWS,news); renderNews(); };
    nT.appendChild(tr);
  });
}
renderNews();
$('#export-news').onclick=()=>downloadJSON(news,'news.json');
$('#import-news').onclick=()=>pickJSON(arr=>{ if(Array.isArray(arr)){ news=arr; save(KEY_NEWS,news); renderNews(); toast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ”ï¸','ok'); } else toast('Array Ù…Ø·Ù„ÙˆØ¨Ø©','err');});
$('#save-news').onclick=()=>saveToRepo('data/news.json',news);

/* ========== Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª ========== */
const KEY_EVENTS='khotwa_events_v1';
let events=load(KEY_EVENTS)||[];
const eForm=$('#form-events'), eSubmit=$('#e_submit'), eEditId=$('#e_edit_id'), eQ=$('#e_q'), eSort=$('#e_sort'), eT=$('#e_table tbody');
const eF={title_ar:$('#e_title_ar'),title_en:$('#e_title_en'),start:$('#e_start'),dur:$('#e_dur'),loc:$('#e_loc'),url:$('#e_url'),tags:$('#e_tags'),image:$('#e_image')};
eForm.addEventListener('submit',e=>{
  e.preventDefault();
  if(!eF.title_ar.value.trim()||!eF.title_en.value.trim()) return toast('Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ÙŠÙ† Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†','err');
  if(!eF.start.value) return toast('ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨','err');
  const startISO=fromLocal(eF.start.value), durH=Math.max(1,Number(eF.dur.value||2));
  const item={id:eEditId.value||cryptoId(),title:{ar:eF.title_ar.value.trim(),en:eF.title_en.value.trim()},startDate:startISO,endDate:new Date(new Date(startISO).getTime()+durH*3600e3).toISOString(),location:eF.loc.value.trim()||'La Trobe â€“ Bundoora',url:eF.url.value.trim(),image:eF.image.value.trim(),tags:splitTags(eF.tags.value)};
  const idx=events.findIndex(x=>x.id===item.id); if(idx>=0) events[idx]=item; else events.push(item);
  save(KEY_EVENTS,events); eForm.reset(); eEditId.value=''; eSubmit.textContent='â• Ø£Ø¶Ù ÙØ¹Ø§Ù„ÙŠØ©'; renderEvents(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ”ï¸','ok');
});
eQ.addEventListener('input',renderEvents); eSort.addEventListener('change',renderEvents);
function renderEvents(){
  eT.innerHTML='';
  let list=events.slice();
  const term=(eQ.value||'').toLowerCase();
  if(term) list=list.filter(x=>JSON.stringify(x).toLowerCase().includes(term));
  if(eSort.value==='date_asc') list.sort((a,b)=>new Date(a.startDate)-new Date(b.startDate));
  if(eSort.value==='date_desc') list.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
  if(eSort.value==='title_ar') list.sort((a,b)=> (a.title.ar||'').localeCompare(b.title.ar||'','ar'));
  if(eSort.value==='title_en') list.sort((a,b)=> (a.title.en||'').localeCompare(b.title.en||'','en'));
  if(list.length===0){ eT.innerHTML='<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¹Ø§Ù„ÙŠØ§Øª.</td></tr>'; return; }
  list.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div>${esc(it.title.ar)}</div><div class="muted">${esc(it.title.en)}</div></td>
      <td>${new Date(it.startDate).toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'})}</td>
      <td>${esc(it.location||'')}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${esc(t)}</span>`).join('')}</td>
      <td><button class="btn" data-edit>ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn err" data-del>Ø­Ø°Ù</button></td>`;
    tr.querySelector('[data-edit]').onclick=()=>{ eF.title_ar.value=it.title.ar; eF.title_en.value=it.title.en; eF.start.value=toLocal(it.startDate); eF.dur.value=((new Date(it.endDate)-new Date(it.startDate))/3600e3)|0; eF.loc.value=it.location||''; eF.url.value=it.url||''; eF.tags.value=(it.tags||[]).join(', '); eF.image.value=it.image||''; eEditId.value=it.id; eSubmit.textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; window.scrollTo({top:0,behavior:'smooth'}); };
    tr.querySelector('[data-del]').onclick=()=>{ events=events.filter(x=>x.id!==it.id); save(KEY_EVENTS,events); renderEvents(); };
    eT.appendChild(tr);
  });
}
renderEvents();
$('#export-events').onclick=()=>downloadJSON(events,'events.json');
$('#import-events').onclick=()=>pickJSON(arr=>{ if(Array.isArray(arr)){ events=arr; save(KEY_EVENTS,events); renderEvents(); toast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ”ï¸','ok'); } else toast('Array Ù…Ø·Ù„ÙˆØ¨Ø©','err');});
$('#save-events').onclick=()=>saveToRepo('data/events.json',events);

/* Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© */
$('#backup').onclick=()=>{
  const bundle={'settings.json':settings,'navigation.json':navItems,'news.json':news,'events.json':events};
  downloadJSON(bundle,'khotwa-backup.json');
};

/* ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† /data Ø¥Ù† ÙˆÙØ¬Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
(async function bootstrap(){
  try{ const s=await fetch('../data/settings.json',{cache:'no-cache'}); if(s.ok){ settings=await s.json(); save(KEY_SETTINGS,settings); fillSettings(); } }catch{}
  try{ const n=await fetch('../data/navigation.json',{cache:'no-cache'}); if(n.ok){ navItems=await n.json(); save(KEY_NAV,navItems); renderNav(); } }catch{}
})();
</script>
