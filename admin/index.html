<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة الإدارة – Khotwa</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{--bg:#0a0f1a;--panel:#0f172a;--ring:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--btn:#111827;--p:#1e40af;--ok:#16a34a;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1200px;margin:auto;padding:16px}
  header{display:flex;align-items:center;gap:.8rem;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:1.25rem}
  .muted{color:var(--muted);font-size:.9rem}
  .tabs{display:flex;gap:.4rem;flex-wrap:wrap;margin:.6rem 0}
  .tab{border:1px solid var(--ring);background:var(--panel);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
  .tab[aria-selected="true"]{background:#111827}
  .panel{background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:12px;margin:12px 0}
  .tools{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.6rem}
  .btn{border:1px solid var(--ring);background:var(--btn);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
  .btn.p{background:var(--p);border-color:transparent}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.err{background:var(--err);border-color:transparent}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  .row-3{grid-template-columns:repeat(3,1fr)}
  label{display:grid;gap:.3rem;font-size:.9rem}
  input,textarea,select{background:#0b1220;border:1px solid var(--ring);color:var(--text);border-radius:10px;padding:.55rem .6rem}
  textarea{min-height:90px;resize:vertical}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:.55rem;border-bottom:1px solid var(--ring);vertical-align:top}
  th{color:var(--muted);font-weight:600;text-align:start}
  .badge{display:inline-block;background:#111827;border:1px solid var(--ring);border-radius:999px;padding:.1rem .5rem;margin:.1rem;font-size:.75rem}
  .right{margin-inline-start:auto}
  code{background:#111827;border:1px solid var(--ring);padding:.12rem .3rem;border-radius:6px}
  .toasts{position:fixed;inset-inline-start:16px;inset-block-end:16px;display:grid;gap:.4rem;z-index:1000}
  .toast{background:#111827;border:1px solid var(--ring);border-radius:10px;padding:.5rem .7rem}
  .toast.ok{background:#0d1f16;border-color:#1f3d2c}
  .toast.err{background:#2a1111;border-color:#4c1d1d}
  @media(max-width:980px){.row,.row-3{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>لوحة الإدارة</h1>
      <div class="muted">إدارة الإعدادات والقائمة + الأخبار والفعاليات. (لا تغيير على الصفحات العامة)</div>
    </div>
    <div class="tools">
      <button class="btn" id="backup">⬇️ تنزيل نسخة احتياطية (JSON)</button>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="الأقسام">
    <button class="tab" role="tab" data-tab="settings" aria-selected="true">⚙️ الإعدادات</button>
    <button class="tab" role="tab" data-tab="nav" aria-selected="false">🧭 القائمة</button>
    <button class="tab" role="tab" data-tab="news" aria-selected="false">📰 الأخبار</button>
    <button class="tab" role="tab" data-tab="events" aria-selected="false">📅 الفعاليات</button>
  </nav>

  <!-- الإعدادات -->
  <section class="panel" data-panel="settings">
    <div class="tools">
      <button class="btn" id="settings-import">⬆️ استيراد</button>
      <button class="btn ok" id="settings-export">⬇️ تصدير</button>
      <button class="btn p" id="settings-save">💾 حفظ للمستودع</button>
    </div>
    <form id="form-settings" class="grid" novalidate>
      <div class="row">
        <label>اسم الموقع <input id="s_siteName" required></label>
        <label>OG Image (URL) <input id="s_og" type="url" placeholder="https://…"></label>
      </div>
      <div class="row">
        <label>الشعار/سطر (AR) <input id="s_tag_ar"></label>
        <label>Tagline (EN) <input id="s_tag_en"></label>
      </div>
      <label>الوصف <textarea id="s_desc"></textarea></label>
      <div class="row">
        <label>Instagram <input id="s_ig" type="url"></label>
        <label>Twitter/X <input id="s_tw" type="url"></label>
      </div>
      <div class="row">
        <label>Facebook <input id="s_fb" type="url"></label>
        <label>LinkedIn <input id="s_in" type="url"></label>
      </div>
      <div class="row">
        <label>حقوق النشر <input id="s_copy" placeholder="Khotwa Student Council"></label>
        <div class="right"></div>
        <button type="submit" class="btn p">💾 حفظ محليًا</button>
      </div>
    </form>
  </section>

  <!-- القائمة -->
  <section class="panel" data-panel="nav" hidden>
    <div class="tools">
      <button class="btn" id="nav-import">⬆️ استيراد</button>
      <button class="btn ok" id="nav-export">⬇️ تصدير</button>
      <button class="btn p" id="nav-save">💾 حفظ للمستودع</button>
      <button class="btn" id="nav-add">➕ إضافة رابط</button>
    </div>
    <table id="nav-table"><thead>
      <tr><th>#</th><th>العربي</th><th>English</th><th>الرابط</th><th>عرض</th><th>إجراءات</th></tr>
    </thead><tbody></tbody></table>
  </section>

  <!-- الأخبار -->
  <section class="panel" data-panel="news" hidden>
    <div class="tools">
      <button class="btn" id="import-news">⬆️ استيراد أخبار</button>
      <button class="btn ok" id="export-news">⬇️ تصدير أخبار</button>
      <button class="btn p" id="save-news">💾 حفظ للمستودع</button>
    </div>
    <form id="form-news" class="grid" novalidate>
      <div class="row">
        <label>العنوان (AR)<input id="n_title_ar" required maxlength="120"></label>
        <label>Title (EN)<input id="n_title_en" required maxlength="120"></label>
      </div>
      <div class="row">
        <label>الملخص (AR)<textarea id="n_desc_ar" maxlength="400"></textarea></label>
        <label>Summary (EN)<textarea id="n_desc_en" maxlength="400"></textarea></label>
      </div>
      <div class="row-3 row">
        <label>التاريخ/الوقت<input type="datetime-local" id="n_date" required></label>
        <label>صورة (URL)<input type="url" id="n_image" placeholder="https://…"></label>
        <label>رابط (اختياري)<input type="url" id="n_url" placeholder="/news.html#id"></label>
      </div>
      <div class="row">
        <label>وسوم (مفصولة بفواصل)<input id="n_tags" placeholder="ann, event, media"></label>
        <div class="right"></div>
        <button type="submit" class="btn p" id="n_submit">➕ أضف خبر</button>
      </div>
      <input type="hidden" id="n_edit_id">
    </form>
    <div class="tools">
      <input id="n_q" placeholder="ابحث في الأخبار…" class="btn" style="width:260px"/>
      <select id="n_sort" class="btn">
        <option value="date_desc">الأحدث أولًا</option>
        <option value="date_asc">الأقدم أولًا</option>
        <option value="title_ar">العنوان (AR)</option>
        <option value="title_en">Title (EN)</option>
      </select>
    </div>
    <table id="n_table"><thead>
      <tr><th>العنوان</th><th>التاريخ</th><th>وسوم</th><th>رابط/صورة</th><th>إجراءات</th></tr>
    </thead><tbody></tbody></table>
  </section>

  <!-- الفعاليات -->
  <section class="panel" data-panel="events" hidden>
    <div class="tools">
      <button class="btn" id="import-events">⬆️ استيراد فعاليات</button>
      <button class="btn ok" id="export-events">⬇️ تصدير فعاليات</button>
      <button class="btn p" id="save-events">💾 حفظ للمستودع</button>
    </div>
    <form id="form-events" class="grid" novalidate>
      <div class="row">
        <label>العنوان (AR)<input id="e_title_ar" required maxlength="120"></label>
        <label>Title (EN)<input id="e_title_en" required maxlength="120"></label>
      </div>
      <div class="row-3 row">
        <label>التاريخ/الوقت (بداية)<input type="datetime-local" id="e_start" required></label>
        <label>المدة بالساعات<input id="e_dur" type="number" min="1" value="2"></label>
        <label>الموقع<input id="e_loc" placeholder="La Trobe – Bundoora"></label>
      </div>
      <div class="row">
        <label>رابط التفاصيل<input id="e_url" type="url" placeholder="/events.html#e1"></label>
        <label>وسوم (مفصولة بفواصل)<input id="e_tags" placeholder="Workshop, Sports"></label>
      </div>
      <div class="row">
        <label>صورة (URL)<input id="e_image" type="url" placeholder="https://…"></label>
        <div class="right"></div>
        <button type="submit" class="btn p" id="e_submit">➕ أضف فعالية</button>
      </div>
      <input type="hidden" id="e_edit_id">
    </form>
    <div class="tools">
      <input id="e_q" placeholder="ابحث في الفعاليات…" class="btn" style="width:260px"/>
      <select id="e_sort" class="btn">
        <option value="date_asc">الأقرب أولًا</option>
        <option value="date_desc">الأبعد أولًا</option>
        <option value="title_ar">العنوان (AR)</option>
        <option value="title_en">Title (EN)</option>
      </select>
    </div>
    <table id="e_table"><thead>
      <tr><th>العنوان</th><th>الوقت</th><th>الموقع</th><th>وسوم</th><th>إجراءات</th></tr>
    </thead><tbody></tbody></table>
  </section>
</div>

<div class="toasts" id="toasts" aria-live="polite"></div>

<script>
/* ========== الربط مع الـWorker ========== */
const API_URL = 'https://khotwastudentcouncil.com/admin/update';
const ADMIN_TOKEN = 'my-secret-1234567890'; // نفس القيمة اللي في ADMIN_TOKEN داخل Cloudflare

/* ========== أدوات مساعدة ========== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const toLocal=iso=>{const d=new Date(iso);d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,16);}
const fromLocal=v=>{const d=new Date(v);return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString();}
const splitTags=s=>(s||'').split(',').map(t=>t.trim()).filter(Boolean);
const cryptoId=()=>crypto.getRandomValues(new Uint32Array(4)).join('-');
function toast(msg,type=''){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;$('#toasts').appendChild(t);setTimeout(()=>t.remove(),2500);}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function load(k){try{return JSON.parse(localStorage.getItem(k)||'null')}catch{return null}}
function downloadJSON(obj,name){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1000);}
function pickJSON(cb){const inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.onchange=async()=>{const f=inp.files[0];if(!f)return;const t=await f.text();try{cb(JSON.parse(t));}catch{toast('JSON غير صالح','err');}};inp.click();}

/* الكتابة للمخزن عبر الـWorker */
async function saveToRepo(path, content){
  try{
    const res = await fetch(API_URL,{
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ADMIN_TOKEN}`,
        'Content-Type':'application/json'
      },
      body: JSON.stringify({ path, content })
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error(txt||('HTTP '+res.status));
    }
    return await res.json();
  }catch(err){
    console.error(err);
    toast('فشل الحفظ: '+err.message,'err');
    throw err;
  }
}

/* ========== تبويبات ========== */
const tabs=$$('.tab'), panels=$$('[data-panel]');
tabs.forEach(b=>b.addEventListener('click',()=>{
  tabs.forEach(t=>t.setAttribute('aria-selected','false'));
  panels.forEach(p=>p.hidden=true);
  b.setAttribute('aria-selected','true');
  document.querySelector(`[data-panel="${b.dataset.tab}"]`).hidden=false;
}));

/* ========== الإعدادات ========== */
const KEY_SETTINGS='khotwa_settings_v1';
let settings=load(KEY_SETTINGS)||{
  siteName:'Khotwa Student Council',
  tagline_ar:'مجلس طلاب خطوة',
  tagline_en:'Khotwa Student Council',
  description:'',
  ogImage:'',
  social:{instagram:'https://www.instagram.com/khotwa.sc/',twitter:'',facebook:'',linkedin:''},
  footer:{copyright:'Khotwa Student Council'}
};
const sF={name:$('#s_siteName'),og:$('#s_og'),tag_ar:$('#s_tag_ar'),tag_en:$('#s_tag_en'),desc:$('#s_desc'),ig:$('#s_ig'),tw:$('#s_tw'),fb:$('#s_fb'),ln:$('#s_in'),copy:$('#s_copy')};
function fillSettings(){ sF.name.value=settings.siteName||''; sF.og.value=settings.ogImage||''; sF.tag_ar.value=settings.tagline_ar||''; sF.tag_en.value=settings.tagline_en||''; sF.desc.value=settings.description||''; sF.ig.value=settings.social?.instagram||''; sF.tw.value=settings.social?.twitter||''; sF.fb.value=settings.social?.facebook||''; sF.ln.value=settings.social?.linkedin||''; sF.copy.value=settings.footer?.copyright||''; }
fillSettings();
$('#form-settings').addEventListener('submit',e=>{
  e.preventDefault();
  settings.siteName=sF.name.value.trim();
  settings.ogImage=sF.og.value.trim();
  settings.tagline_ar=sF.tag_ar.value.trim();
  settings.tagline_en=sF.tag_en.value.trim();
  settings.description=sF.desc.value.trim();
  settings.social={instagram:sF.ig.value.trim(),twitter:sF.tw.value.trim(),facebook:sF.fb.value.trim(),linkedin:sF.ln.value.trim()};
  settings.footer={copyright:sF.copy.value.trim()||'Khotwa Student Council'};
  save(KEY_SETTINGS,settings); toast('تم الحفظ محليًا ✔️','ok');
});
$('#settings-export').onclick=()=>downloadJSON(settings,'settings.json');
$('#settings-import').onclick=()=>pickJSON(obj=>{settings=obj;save(KEY_SETTINGS,settings);fillSettings();toast('تم الاستيراد ✔️','ok');});
$('#settings-save').onclick=()=>saveToRepo('data/settings.json',settings).then(()=>toast('حُفظ للمستودع ✔️','ok'));

/* ========== القائمة ========== */
const KEY_NAV='khotwa_nav_v1';
let navItems=load(KEY_NAV)||[];
const navT=$('#nav-table tbody');
function renderNav(){
  navT.innerHTML='';
  navItems.sort((a,b)=>(a.order||0)-(b.order||0));
  if(navItems.length===0){ navT.innerHTML='<tr><td colspan="6" class="muted">لا توجد عناصر.</td></tr>'; return; }
  navItems.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><input value="${esc(it.ar||'')}" data-f="ar" style="width:100%"></td>
      <td><input value="${esc(it.en||'')}" data-f="en" style="width:100%"></td>
      <td><input value="${esc(it.href||'')}" data-f="href" style="width:100%"></td>
      <td><input type="checkbox" ${it.visible!==false?'checked':''} data-f="visible"></td>
      <td>
        <button class="btn" data-up>⬆️</button>
        <button class="btn" data-down>⬇️</button>
        <button class="btn err" data-del>🗑️</button>
      </td>`;
    tr.querySelectorAll('input').forEach(inp=>{
      inp.oninput=()=>{
        const f=inp.dataset.f;
        if(f==='visible') it.visible=inp.checked;
        else it[f]=inp.value;
        save(KEY_NAV,navItems);
      };
    });
    tr.querySelector('[data-up]').onclick=()=>{ if(idx>0){ [navItems[idx-1],navItems[idx]]=[navItems[idx],navItems[idx-1]]; save(KEY_NAV,navItems); renderNav(); } };
    tr.querySelector('[data-down]').onclick=()=>{ if(idx<navItems.length-1){ [navItems[idx+1],navItems[idx]]=[navItems[idx],navItems[idx+1]]; save(KEY_NAV,navItems); renderNav(); } };
    tr.querySelector('[data-del]').onclick=()=>{ navItems=navItems.filter(x=>x!==it); save(KEY_NAV,navItems); renderNav(); };
    navT.appendChild(tr);
  });
}
renderNav();
$('#nav-add').onclick=()=>{ navItems.push({id:cryptoId(),ar:'عن',en:'About',href:'/about.html',visible:true,order:navItems.length+1}); save(KEY_NAV,navItems); renderNav(); };
$('#nav-export').onclick=()=>downloadJSON(navItems,'navigation.json');
$('#nav-import').onclick=()=>pickJSON(arr=>{ if(Array.isArray(arr)){ navItems=arr; save(KEY_NAV,navItems); renderNav(); toast('تم الاستيراد ✔️','ok'); } else toast('Array مطلوبة','err');});
$('#nav-save').onclick=()=>saveToRepo('data/navigation.json',navItems).then(()=>toast('حُفظ للمستودع ✔️','ok'));

/* ========== الأخبار ========== */
const KEY_NEWS='khotwa_news_v1';
let news=load(KEY_NEWS)||[];
const nForm=$('#form-news'), nSubmit=$('#n_submit'), nEditId=$('#n_edit_id'), nQ=$('#n_q'), nSort=$('#n_sort'), nT=$('#n_table tbody');
const nF={title_ar:$('#n_title_ar'),title_en:$('#n_title_en'),desc_ar:$('#n_desc_ar'),desc_en:$('#n_desc_en'),date:$('#n_date'),image:$('#n_image'),url:$('#n_url'),tags:$('#n_tags')};
nForm.addEventListener('submit',e=>{
  e.preventDefault();
  if(!nF.title_ar.value.trim()||!nF.title_en.value.trim()) return toast('العنوانين مطلوبين','err');
  if(!nF.date.value) return toast('التاريخ/الوقت مطلوب','err');
  const item={id:nEditId.value||cryptoId(),title:{ar:nF.title_ar.value.trim(),en:nF.title_en.value.trim()},summary:{ar:nF.desc_ar.value.trim(),en:nF.desc_en.value.trim()},date:fromLocal(nF.date.value),image:nF.image.value.trim(),url:nF.url.value.trim(),tags:splitTags(nF.tags.value)};
  const idx=news.findIndex(x=>x.id===item.id); if(idx>=0) news[idx]=item; else news.unshift(item);
  save(KEY_NEWS,news); nForm.reset(); nEditId.value=''; nSubmit.textContent='➕ أضف خبر'; renderNews(); toast('تم الحفظ ✔️','ok');
});
nQ.addEventListener('input',renderNews); nSort.addEventListener('change',renderNews);
function renderNews(){
  nT.innerHTML='';
  let list=news.slice();
  const term=(nQ.value||'').toLowerCase();
  if(term) list=list.filter(x=>JSON.stringify(x).toLowerCase().includes(term));
  if(nSort.value==='date_asc') list.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(nSort.value==='date_desc') list.sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(nSort.value==='title_ar') list.sort((a,b)=> (a.title.ar||'').localeCompare(b.title.ar||'','ar'));
  if(nSort.value==='title_en') list.sort((a,b)=> (a.title.en||'').localeCompare(b.title.en||'','en'));
  if(list.length===0){ nT.innerHTML='<tr><td colspan="5" class="muted">لا توجد أخبار.</td></tr>'; return; }
  list.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div>${esc(it.title.ar)}</div><div class="muted">${esc(it.title.en)}</div></td>
      <td>${new Date(it.date).toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'})}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${esc(t)}</span>`).join('')}</td>
      <td>${it.image?`🖼️ <a href="${esc(it.image)}" target="_blank">صورة</a><br>`:''}${it.url?`🔗 <a href="${esc(it.url)}" target="_blank">رابط</a>`:''}</td>
      <td><button class="btn" data-edit>تعديل</button> <button class="btn err" data-del>حذف</button></td>`;
    tr.querySelector('[data-edit]').onclick=()=>{ nF.title_ar.value=it.title.ar; nF.title_en.value=it.title.en; nF.desc_ar.value=it.summary.ar; nF.desc_en.value=it.summary.en; nF.date.value=toLocal(it.date); nF.image.value=it.image||''; nF.url.value=it.url||''; nF.tags.value=(it.tags||[]).join(', '); nEditId.value=it.id; nSubmit.textContent='💾 حفظ التعديل'; window.scrollTo({top:0,behavior:'smooth'}); };
    tr.querySelector('[data-del]').onclick=()=>{ news=news.filter(x=>x.id!==it.id); save(KEY_NEWS,news); renderNews(); };
    nT.appendChild(tr);
  });
}
renderNews();
$('#export-news').onclick=()=>downloadJSON(news,'news.json');
$('#import-news').onclick=()=>pickJSON(arr=>{ if(Array.isArray(arr)){ news=arr; save(KEY_NEWS,news); renderNews(); toast('تم الاستيراد ✔️','ok'); } else toast('Array مطلوبة','err');});
$('#save-news').onclick=()=>saveToRepo('data/news.json',news).then(()=>toast('حُفظ للمستودع ✔️','ok'));

/* ========== الفعاليات ========== */
const KEY_EVENTS='khotwa_events_v1';
let events=load(KEY_EVENTS)||[];
const eForm=$('#form-events'), eSubmit=$('#e_submit'), eEditId=$('#e_edit_id'), eQ=$('#e_q'), eSort=$('#e_sort'), eT=$('#e_table tbody');
const eF={title_ar:$('#e_title_ar'),title_en:$('#e_title_en'),start:$('#e_start'),dur:$('#e_dur'),loc:$('#e_loc'),url:$('#e_url'),tags:$('#e_tags'),image:$('#e_image')};
eForm.addEventListener('submit',e=>{
  e.preventDefault();
  if(!eF.title_ar.value.trim()||!eF.title_en.value.trim()) return toast('العنوانين مطلوبين','err');
  if(!eF.start.value) return toast('وقت البداية مطلوب','err');
  const startISO=fromLocal(eF.start.value), durH=Math.max(1,Number(eF.dur.value||2));
  const item={id:eEditId.value||cryptoId(),title:{ar:eF.title_ar.value.trim(),en:eF.title_en.value.trim()},startDate:startISO,endDate:new Date(new Date(startISO).getTime()+durH*3600e3).toISOString(),location:eF.loc.value.trim()||'La Trobe – Bundoora',url:eF.url.value.trim(),image:eF.image.value.trim(),tags:splitTags(eF.tags.value)};
  const idx=events.findIndex(x=>x.id===item.id); if(idx>=0) events[idx]=item; else events.push(item);
  save(KEY_EVENTS,events); eForm.reset(); eEditId.value=''; eSubmit.textContent='➕ أضف فعالية'; renderEvents(); toast('تم الحفظ ✔️','ok');
});
eQ.addEventListener('input',renderEvents); eSort.addEventListener('change',renderEvents);
function renderEvents(){
  eT.innerHTML='';
  let list=events.slice();
  const term=(eQ.value||'').toLowerCase();
  if(term) list=list.filter(x=>JSON.stringify(x).toLowerCase().includes(term));
  if(eSort.value==='date_asc') list.sort((a,b)=>new Date(a.startDate)-new Date(b.startDate));
  if(eSort.value==='date_desc') list.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
  if(eSort.value==='title_ar') list.sort((a,b)=> (a.title.ar||'').localeCompare(b.title.ar||'','ar'));
  if(eSort.value==='title_en') list.sort((a,b)=> (a.title.en||'').localeCompare(b.title.en||'','en'));
  if(list.length===0){ eT.innerHTML='<tr><td colspan="5" class="muted">لا توجد فعاليات.</td></tr>'; return; }
  list.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div>${esc(it.title.ar)}</div><div class="muted">${esc(it.title.en)}</div></td>
      <td>${new Date(it.startDate).toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'})}</td>
      <td>${esc(it.location||'')}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${esc(t)}</span>`).join('')}</td>
      <td><button class="btn" data-edit>تعديل</button> <button class="btn err" data-del>حذف</button></td>`;
    tr.querySelector('[data-edit]').onclick=()=>{ eF.title_ar.value=it.title.ar; eF.title_en.value=it.title.en; eF.start.value=toLocal(it.startDate); eF.dur.value=((new Date(it.endDate)-new Date(it.startDate))/3600e3)|0; eF.loc.value=it.location||''; eF.url.value=it.url||''; eF.tags.value=(it.tags||[]).join(', '); eF.image.value=it.image||''; eEditId.value=it.id; eSubmit.textContent='💾 حفظ التعديل'; window.scrollTo({top:0,behavior:'smooth'}); };
    tr.querySelector('[data-del]').onclick=()=>{ events=events.filter(x=>x.id!==it.id); save(KEY_EVENTS,events); renderEvents(); };
    eT.appendChild(tr);
  });
}
renderEvents();
$('#export-events').onclick=()=>downloadJSON(events,'events.json');
$('#import-events').onclick=()=>pickJSON(arr=>{ if(Array.isArray(arr)){ events=arr; save(KEY_EVENTS,events); renderEvents(); toast('تم الاستيراد ✔️','ok'); } else toast('Array مطلوبة','err');});
$('#save-events').onclick=()=>saveToRepo('data/events.json',events).then(()=>toast('حُفظ للمستودع ✔️','ok'));

/* نسخة احتياطية */
$('#backup').onclick=()=>{
  const bundle={'settings.json':settings,'navigation.json':navItems,'news.json':news,'events.json':events};
  downloadJSON(bundle,'khotwa-backup.json');
};

/* تحميل مبدئي من /data إن وُجد (اختياري) */
(async function bootstrap(){
  try{ const s=await fetch('../data/settings.json',{cache:'no-cache'}); if(s.ok){ settings=await s.json(); save(KEY_SETTINGS,settings); fillSettings(); } }catch{}
  try{ const n=await fetch('../data/navigation.json',{cache:'no-cache'}); if(n.ok){ navItems=await n.json(); save(KEY_NAV,navItems); renderNav(); } }catch{}
})();
</script>
</body>
</html>
