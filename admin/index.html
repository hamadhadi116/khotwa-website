<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€“ Khotwa</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{--bg:#0a0f1a;--panel:#0f172a;--ring:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--btn:#111827;--p:#1e40af;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  header{display:flex;align-items:center;gap:.8rem;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:1.25rem}
  .muted{color:var(--muted);font-size:.9rem}
  .tabs{display:flex;gap:.4rem;margin:.6rem 0}
  .tab{border:1px solid var(--ring);background:var(--panel);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
  .tab[aria-selected="true"]{background:#111827}
  .panel{background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:12px;margin:12px 0}
  .tools{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.6rem}
  .btn{border:1px solid var(--ring);background:var(--btn);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
  .btn.p{background:var(--p);border-color:transparent}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.warn{background:var(--warn);border-color:transparent;color:#111}
  .btn.err{background:var(--err);border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  .row-3{grid-template-columns:repeat(3,1fr)}
  label{display:grid;gap:.3rem;font-size:.9rem}
  input,textarea,select{background:#0b1220;border:1px solid var(--ring);color:var(--text);border-radius:10px;padding:.55rem .6rem}
  textarea{min-height:90px;resize:vertical}
  .hint{font-size:.75rem;color:var(--muted);display:flex;justify-content:space-between}
  .error{color:#fecaca}
  .preview{display:flex;gap:.5rem;align-items:center}
  .preview img{width:48px;height:36px;object-fit:cover;border-radius:6px;border:1px solid var(--ring)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:.55rem;border-bottom:1px solid var(--ring);vertical-align:top}
  th{color:var(--muted);font-weight:600;text-align:start}
  .badge{display:inline-block;background:#111827;border:1px solid var(--ring);border-radius:999px;padding:.1rem .5rem;margin:.1rem;font-size:.75rem}
  .right{margin-inline-start:auto}
  code{background:#111827;border:1px solid var(--ring);padding:.12rem .3rem;border-radius:6px}
  .divider{height:1px;background:var(--ring);margin:.6rem 0}
  /* Toasts */
  .toasts{position:fixed;inset-inline-start:16px;inset-block-end:16px;display:grid;gap:.4rem;z-index:1000}
  .toast{background:#111827;border:1px solid var(--ring);border-radius:10px;padding:.5rem .7rem;box-shadow:0 10px 26px rgba(0,0,0,.25)}
  .toast.ok{background:#0d1f16;border-color:#1f3d2c}
  .toast.err{background:#2a1111;border-color:#4c1d1d}
  /* Modal confirm */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:999}
  .modal[open]{display:flex}
  .modal .box{background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:1rem;max-width:420px;width:92%}
  .modal .box .actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.8rem}
  /* Loader */
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid #9ca3af;border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin-inline-start:.4rem}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:900px){.row,.row-3{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„ â€“ Ù…Ø­Ø³Ù‘Ù†Ø©)</h1>
      <div class="muted">Ø£Ø¶Ù/Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª â†’ ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSONØŒ Ø£Ùˆ Ø§Ø­ÙØ¸ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ø¨Ø± API. Ù„Ø§ ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ù‡ÙŠØ§ÙƒÙ„ ØµÙØ­Ø§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.</div>
    </div>
    <div class="tools">
      <button class="btn" id="import-news">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø®Ø¨Ø§Ø±</button>
      <button class="btn ok" id="export-news">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø£Ø®Ø¨Ø§Ø±</button>
      <button class="btn" id="import-events">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙØ¹Ø§Ù„ÙŠØ§Øª</button>
      <button class="btn ok" id="export-events">â¬‡ï¸ ØªØµØ¯ÙŠØ± ÙØ¹Ø§Ù„ÙŠØ§Øª</button>
      <!-- Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø­ÙØ¸ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø±Ø¨Ø·) -->
      <button class="btn p" id="save-news-remote">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹</button>
      <button class="btn p" id="save-events-remote">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹</button>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Ø§Ù„Ø£Ù‚Ø³Ø§Ù…">
    <button class="tab" role="tab" id="tab-news" aria-selected="true" aria-controls="panel-news">ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
    <button class="tab" role="tab" id="tab-events" aria-selected="false" aria-controls="panel-events">ğŸ“… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</button>
  </nav>

  <!-- Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„) -->
  <section class="panel" id="panel-news" role="tabpanel" aria-labelledby="tab-news">
    <form id="form-news" class="grid" novalidate>
      <div class="row">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (AR)
          <input id="n_title_ar" required maxlength="120">
          <div class="hint"><span>Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§.</span><span><span id="n_len_ar">0</span>/120</span></div>
        </label>
        <label>Title (EN)
          <input id="n_title_en" required maxlength="120">
          <div class="hint"><span>English title.</span><span><span id="n_len_en">0</span>/120</span></div>
        </label>
      </div>
      <div class="row">
        <label>Ø§Ù„Ù…Ù„Ø®Øµ (AR)
          <textarea id="n_desc_ar" maxlength="400"></textarea>
          <div class="hint"><span>Ù…Ø®ØªØµØ± 1â€“3 Ø¬Ù…Ù„.</span><span><span id="n_desc_ar_len">0</span>/400</span></div>
        </label>
        <label>Summary (EN)
          <textarea id="n_desc_en" maxlength="400"></textarea>
          <div class="hint"><span>Short summary.</span><span><span id="n_desc_en_len">0</span>/400</span></div>
        </label>
      </div>
      <div class="row-3 row">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª
          <input type="datetime-local" id="n_date" required>
          <div class="hint"><span class="error" id="n_date_err"></span><span></span></div>
        </label>
        <label>ØµÙˆØ±Ø© (URL)
          <div class="preview">
            <input type="url" id="n_image" placeholder="https://â€¦">
            <img id="n_img_prev" alt="" aria-hidden="true">
          </div>
          <div class="hint"><span>Ø§Ø®ØªÙŠØ§Ø±ÙŠ.</span><span></span></div>
        </label>
        <label>Ø±Ø§Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          <input type="url" id="n_url" placeholder="/news.html#id">
          <div class="hint"><span>Ø±Ø§Ø¨Ø· ØªÙØµÙŠÙ„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯.</span><span></span></div>
        </label>
      </div>
      <div class="row">
        <label>ÙˆØ³ÙˆÙ… (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)
          <input id="n_tags" placeholder="Announcements, Workshop">
          <div class="hint"><span>Ù…Ø«Ø§Ù„: ann,event,mediaâ€¦</span><span></span></div>
        </label>
        <div class="right"></div>
        <button type="submit" class="btn p" id="n_submit">â• Ø£Ø¶Ù Ø®Ø¨Ø±</button>
      </div>
      <input type="hidden" id="n_edit_id">
    </form>

    <div class="tools">
      <input id="n_q" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±â€¦" class="btn" style="width:260px"/>
      <select id="n_sort" class="btn">
        <option value="date_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ù‹Ø§</option>
        <option value="date_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ù‹Ø§</option>
        <option value="title_ar">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (AR)</option>
        <option value="title_en">Title (EN)</option>
      </select>
      <button class="btn" id="n_copy">ğŸ“‹ Ù†Ø³Ø® JSON</button>
    </div>
    <table id="n_table"><thead>
      <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ÙˆØ³ÙˆÙ…</th><th>Ø±Ø§Ø¨Ø·/ØµÙˆØ±Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
    </thead><tbody></tbody></table>
  </section>

  <!-- Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª (Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„) -->
  <section class="panel" id="panel-events" role="tabpanel" aria-labelledby="tab-events" hidden>
    <form id="form-events" class="grid" novalidate>
      <div class="row">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (AR)
          <input id="e_title_ar" required maxlength="120">
          <div class="hint"><span></span><span><span id="e_len_ar">0</span>/120</span></div>
        </label>
        <label>Title (EN)
          <input id="e_title_en" required maxlength="120">
          <div class="hint"><span></span><span><span id="e_len_en">0</span>/120</span></div>
        </label>
      </div>
      <div class="row-3 row">
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª (Ø¨Ø¯Ø§ÙŠØ©)
          <input type="datetime-local" id="e_start" required>
          <div class="hint"><span class="error" id="e_date_err"></span><span></span></div>
        </label>
        <label>Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª
          <input id="e_dur" type="number" min="1" value="2">
          <div class="hint"><span>Ø§ÙØªØ±Ø§Ø¶ÙŠ 2 Ø³Ø§Ø¹Ø§Øª.</span><span></span></div>
        </label>
        <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹
          <input id="e_loc" placeholder="La Trobe â€“ Bundoora">
          <div class="hint"><span></span><span></span></div>
        </label>
      </div>
      <div class="row">
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„
          <input id="e_url" type="url" placeholder="/events.html#e1">
        </label>
        <label>ÙˆØ³ÙˆÙ… (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)
          <input id="e_tags" placeholder="Workshop, Sports">
        </label>
      </div>
      <div class="row">
        <label>ØµÙˆØ±Ø© (URL)
          <div class="preview">
            <input id="e_image" type="url" placeholder="https://â€¦">
            <img id="e_img_prev" alt="" aria-hidden="true">
          </div>
        </label>
        <div class="right"></div>
        <button type="submit" class="btn p" id="e_submit">â• Ø£Ø¶Ù ÙØ¹Ø§Ù„ÙŠØ©</button>
      </div>
      <input type="hidden" id="e_edit_id">
    </form>

    <div class="tools">
      <input id="e_q" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øªâ€¦" class="btn" style="width:260px"/>
      <select id="e_sort" class="btn">
        <option value="date_asc">Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø£ÙˆÙ„Ù‹Ø§</option>
        <option value="date_desc">Ø§Ù„Ø£Ø¨Ø¹Ø¯ Ø£ÙˆÙ„Ù‹Ø§</option>
        <option value="title_ar">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (AR)</option>
        <option value="title_en">Title (EN)</option>
      </select>
      <button class="btn" id="e_copy">ğŸ“‹ Ù†Ø³Ø® JSON</button>
    </div>
    <table id="e_table"><thead>
      <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>ÙˆØ³ÙˆÙ…</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
    </thead><tbody></tbody></table>
  </section>
</div>

<!-- Toasts + Modal -->
<div class="toasts" id="toasts" aria-live="polite"></div>
<div class="modal" id="confirm">
  <div class="box">
    <div id="confirm-text">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ</div>
    <div class="actions">
      <button class="btn" id="confirm-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn err" id="confirm-ok">Ø­Ø°Ù</button>
    </div>
  </div>
</div>

<script>
/* ===== Ø«ÙˆØ§Ø¨Øª Ø¹Ø§Ù…Ø© ===== */
const KEY_NEWS='khotwa_news_v1', KEY_EVENTS='khotwa_events_v1';
const DRAFT_NEWS='khotwa_news_draft', DRAFT_EVENTS='khotwa_events_draft';
const PREF='khotwa_admin_pref';
const API_URL = ''; // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Worker Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¥Ù† Ø±ØºØ¨Øª Ø¨Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±

/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
const $ = s=>document.querySelector(s);
const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const toLocal = iso=>{const d=new Date(iso);d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,16);}
const fromLocal= val=>{const d=new Date(val);return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString();}
const splitTags = s=> (s||'').split(',').map(t=>t.trim()).filter(Boolean);
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function load(k){try{return JSON.parse(localStorage.getItem(k)||'null')}catch{return null}}
function cryptoId(){ return (self.crypto?.randomUUID ? crypto.randomUUID() : 'id_'+Math.random().toString(36).slice(2)); }
function toast(msg, type=''){ const t=document.createElement('div'); t.className='toast '+type; t.textContent=msg; $('#toasts').appendChild(t); setTimeout(()=>t.remove(), 3000); }
function copy(text){ navigator.clipboard?.writeText(text).then(()=>toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ”ï¸','ok')).catch(()=>toast('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®','err')); }
function confirmBox(text){ return new Promise(res=>{ $('#confirm-text').textContent=text; const m=$('#confirm'); m.setAttribute('open',''); const ok=()=>{cleanup();res(true)}; const cancel=()=>{cleanup();res(false)}; $('#confirm-ok').onclick=ok; $('#confirm-cancel').onclick=cancel; m.onclick=(e)=>{ if(e.target===m) cancel();}; function cleanup(){ m.removeAttribute('open'); $('#confirm-ok').onclick=null; $('#confirm-cancel').onclick=null; m.onclick=null; } }); }
function downloadJSON(obj, name){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

/* ===== Ø¨ÙŠØ§Ù†Ø§Øª ===== */
let news = load(KEY_NEWS) || [];
let events = load(KEY_EVENTS) || [];
const pref = load(PREF) || { tab:'news', n_sort:'date_desc', e_sort:'date_asc', n_q:'', e_q:'' };

/* ===== ØªØ¨ÙˆÙŠØ¨Ø§Øª ===== */
const tabNews=$('#tab-news'), tabEvents=$('#tab-events');
const pnlNews=$('#panel-news'), pnlEvents=$('#panel-events');
function setTab(tab){
  pref.tab = tab; save(PREF,pref);
  const newsOn = tab==='news';
  tabNews.setAttribute('aria-selected', String(newsOn));
  tabEvents.setAttribute('aria-selected', String(!newsOn));
  pnlNews.hidden = !newsOn; pnlEvents.hidden = newsOn;
}
tabNews.onclick=()=>setTab('news'); tabEvents.onclick=()=>setTab('events');
setTab(pref.tab);

/* ===== Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ===== */
const nForm=$('#form-news'), nSubmit=$('#n_submit'), nEditId=$('#n_edit_id');
const nQ=$('#n_q'), nSort=$('#n_sort'), nT=$('#n_table tbody');
const nF={
  title_ar:$('#n_title_ar'), title_en:$('#n_title_en'),
  desc_ar:$('#n_desc_ar'), desc_en:$('#n_desc_en'),
  date:$('#n_date'), image:$('#n_image'), url:$('#n_url'), tags:$('#n_tags'),
  len_ar:$('#n_len_ar'), len_en:$('#n_len_en'),
  desc_ar_len:$('#n_desc_ar_len'), desc_en_len:$('#n_desc_en_len'),
  date_err:$('#n_date_err'), img_prev:$('#n_img_prev')
};
[nF.title_ar,nF.title_en,nF.desc_ar,nF.desc_en].forEach(inp=>{
  inp.addEventListener('input',()=>{
    if(inp===nF.title_ar) nF.len_ar.textContent=inp.value.length;
    if(inp===nF.title_en) nF.len_en.textContent=inp.value.length;
    if(inp===nF.desc_ar) nF.desc_ar_len.textContent=inp.value.length;
    if(inp===nF.desc_en) nF.desc_en_len.textContent=inp.value.length;
    saveDraft('news');
  });
});
nF.image.addEventListener('input', ()=>{
  const u=nF.image.value.trim(); nF.img_prev.src = u; nF.img_prev.hidden = !u;
  saveDraft('news');
});
[nF.date,nF.url,nF.tags].forEach(inp=> inp.addEventListener('input',()=>saveDraft('news')));

nQ.value = pref.n_q||''; nSort.value = pref.n_sort||'date_desc';
nQ.addEventListener('input',()=>{pref.n_q=nQ.value; save(PREF,pref); renderNews();});
nSort.addEventListener('change',()=>{pref.n_sort=nSort.value; save(PREF,pref); renderNews();});

nForm.addEventListener('submit', e=>{
  e.preventDefault();
  nF.date_err.textContent='';
  if(!nF.title_ar.value.trim() || !nF.title_en.value.trim()) return toast('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†','err');
  if(!nF.date.value) { nF.date_err.textContent='Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª Ù…Ø·Ù„ÙˆØ¨'; return; }

  const item={
    id: nEditId.value || cryptoId(),
    title:{ar:nF.title_ar.value.trim(), en:nF.title_en.value.trim()},
    summary:{ar:nF.desc_ar.value.trim(), en:nF.desc_en.value.trim()},
    date: fromLocal(nF.date.value),
    image:nF.image.value.trim(),
    url:nF.url.value.trim(),
    tags: splitTags(nF.tags.value)
  };
  const idx=news.findIndex(x=>x.id===item.id);
  if(idx>=0){ news[idx]=item; toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ”ï¸','ok'); }
  else{ news.unshift(item); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø± âœ”ï¸','ok'); }

  save(KEY_NEWS,news);
  clearForm('news'); renderNews();
});

function renderNews(){
  nT.innerHTML='';
  let list = news.slice();
  // Ø¨Ø­Ø«
  const term=(nQ.value||'').toLowerCase();
  if(term) list = list.filter(x=> JSON.stringify(x).toLowerCase().includes(term));
  // ÙØ±Ø²
  if(nSort.value==='date_asc') list.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(nSort.value==='date_desc') list.sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(nSort.value==='title_ar') list.sort((a,b)=> (a.title.ar||'').localeCompare(b.title.ar||'','ar'));
  if(nSort.value==='title_en') list.sort((a,b)=> (a.title.en||'').localeCompare(b.title.en||'','en'));
  // Ø¹Ø±Ø¶
  if(list.length===0){ nT.innerHTML='<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±.</td></tr>'; return; }
  for(const it of list){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div>${esc(it.title.ar)}</div><div class="muted">${esc(it.title.en)}</div></td>
      <td>${new Date(it.date).toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'})}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${esc(t)}</span>`).join('')}</td>
      <td>
        ${it.image?`ğŸ–¼ï¸ <a href="${esc(it.image)}" target="_blank" rel="noopener">ØµÙˆØ±Ø©</a><br>`:''}
        ${it.url?`ğŸ”— <a href="${esc(it.url)}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø·</a>`:''}
      </td>
      <td>
        <button class="btn" data-edit>ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn warn" data-copy>Ù†Ø³Ø®</button>
        <button class="btn err" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector('[data-edit]').onclick=()=> editNews(it);
    tr.querySelector('[data-copy]').onclick=()=> copy(JSON.stringify(it,null,2));
    tr.querySelector('[data-del]').onclick=async()=>{
      const ok = await confirmBox('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®Ø¨Ø±ØŸ');
      if(!ok) return;
      const backup=[...news];
      news=news.filter(n=>n.id!==it.id); save(KEY_NEWS,news); renderNews(); 
      const undo=document.createElement('button'); undo.className='btn'; undo.textContent='ØªØ±Ø§Ø¬Ø¹';
      const t=document.createElement('div'); t.className='toast'; t.textContent='ØªÙ… Ø§Ù„Ø­Ø°Ù '; t.appendChild(undo); $('#toasts').appendChild(t);
      const timer=setTimeout(()=>t.remove(),4000);
      undo.onclick=()=>{ clearTimeout(timer); t.remove(); news=backup; save(KEY_NEWS,news); renderNews(); toast('ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ âœ”ï¸','ok'); };
    };
    nT.appendChild(tr);
  }
}
function editNews(it){
  nF.title_ar.value=it.title.ar; nF.title_en.value=it.title.en;
  nF.desc_ar.value=it.summary.ar; nF.desc_en.value=it.summary.en;
  nF.date.value=toLocal(it.date); nF.image.value=it.image||''; nF.url.value=it.url||'';
  nF.tags.value=(it.tags||[]).join(', ');
  nF.len_ar.textContent = nF.title_ar.value.length; nF.len_en.textContent = nF.title_en.value.length;
  nF.desc_ar_len.textContent = nF.desc_ar.value.length; nF.desc_en_len.textContent = nF.desc_en.value.length;
  nF.img_prev.src = it.image||''; nF.img_prev.hidden = !it.image;
  nEditId.value=it.id; nSubmit.textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  window.scrollTo({top:0,behavior:'smooth'});
}
function clearForm(which){
  if(which==='news'){
    nForm.reset(); nEditId.value=''; nSubmit.textContent='â• Ø£Ø¶Ù Ø®Ø¨Ø±';
    nF.len_ar.textContent='0'; nF.len_en.textContent='0'; nF.desc_ar_len.textContent='0'; nF.desc_en_len.textContent='0';
    nF.img_prev.removeAttribute('src'); nF.img_prev.hidden = true;
    localStorage.removeItem(DRAFT_NEWS);
  }
}

/* ===== Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª ===== */
const eForm=$('#form-events'), eSubmit=$('#e_submit'), eEditId=$('#e_edit_id');
const eQ=$('#e_q'), eSort=$('#e_sort'), eT=$('#e_table tbody');
const eF={
  title_ar:$('#e_title_ar'), title_en:$('#e_title_en'),
  start:$('#e_start'), dur:$('#e_dur'), loc:$('#e_loc'),
  url:$('#e_url'), tags:$('#e_tags'), image:$('#e_image'),
  len_ar:$('#e_len_ar'), len_en:$('#e_len_en'), date_err:$('#e_date_err'), img_prev:$('#e_img_prev')
};
[eF.title_ar,eF.title_en].forEach(inp=> inp.addEventListener('input',()=>{ 
  if(inp===eF.title_ar) (eF.len_ar||{}).textContent=inp.value.length; 
  if(inp===eF.title_en) (eF.len_en||{}).textContent=inp.value.length; 
  saveDraft('events');
}));
[eF.start,eF.dur,eF.loc,eF.url,eF.tags,eF.image].forEach(inp=> inp.addEventListener('input',()=>{ if(inp===eF.image){ eF.img_prev.src=inp.value.trim(); eF.img_prev.hidden = !inp.value.trim(); } saveDraft('events'); }));

eQ.value = pref.e_q||''; eSort.value = pref.e_sort||'date_asc';
eQ.addEventListener('input',()=>{pref.e_q=eQ.value; save(PREF,pref); renderEvents();});
eSort.addEventListener('change',()=>{pref.e_sort=eSort.value; save(PREF,pref); renderEvents();});

eForm.addEventListener('submit', e=>{
  e.preventDefault();
  eF.date_err.textContent='';
  if(!eF.title_ar.value.trim() || !eF.title_en.value.trim()) return toast('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†','err');
  if(!eF.start.value) { eF.date_err.textContent='ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨'; return; }
  const startISO=fromLocal(eF.start.value);
  const durH=Math.max(1, Number(eF.dur.value||2));
  const item={
    id: eEditId.value || cryptoId(),
    title:{ar:eF.title_ar.value.trim(), en:eF.title_en.value.trim()},
    startDate:startISO,
    endDate:new Date(new Date(startISO).getTime()+durH*3600e3).toISOString(),
    location:eF.loc.value.trim()||'La Trobe â€“ Bundoora',
    url:eF.url.value.trim(),
    image:eF.image.value.trim(),
    tags: splitTags(eF.tags.value)
  };
  const idx=events.findIndex(x=>x.id===item.id);
  if(idx>=0){ events[idx]=item; toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ”ï¸','ok'); }
  else{ events.push(item); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© âœ”ï¸','ok'); }
  save(KEY_EVENTS,events);
  clearForm('events'); renderEvents();
});

function renderEvents(){
  eT.innerHTML='';
  let list = events.slice();
  const term=(eQ.value||'').toLowerCase();
  if(term) list = list.filter(x=> JSON.stringify(x).toLowerCase().includes(term));
  if(eSort.value==='date_asc') list.sort((a,b)=>new Date(a.startDate)-new Date(b.startDate));
  if(eSort.value==='date_desc') list.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
  if(eSort.value==='title_ar') list.sort((a,b)=> (a.title.ar||'').localeCompare(b.title.ar||'','ar'));
  if(eSort.value==='title_en') list.sort((a,b)=> (a.title.en||'').localeCompare(b.title.en||'','en'));
  if(list.length===0){ eT.innerHTML='<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¹Ø§Ù„ÙŠØ§Øª.</td></tr>'; return; }
  for(const it of list){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div>${esc(it.title.ar)}</div><div class="muted">${esc(it.title.en)}</div></td>
      <td>${new Date(it.startDate).toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'})}</td>
      <td>${esc(it.location||'')}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${esc(t)}</span>`).join('')}</td>
      <td>
        <button class="btn" data-edit>ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn warn" data-copy>Ù†Ø³Ø®</button>
        <button class="btn err" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector('[data-edit]').onclick=()=> editEvent(it);
    tr.querySelector('[data-copy]').onclick=()=> copy(JSON.stringify(it,null,2));
    tr.querySelector('[data-del]').onclick=async()=>{
      const ok = await confirmBox('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©ØŸ');
      if(!ok) return;
      const backup=[...events];
      events=events.filter(x=>x.id!==it.id); save(KEY_EVENTS,events); renderEvents();
      const undo=document.createElement('button'); undo.className='btn'; undo.textContent='ØªØ±Ø§Ø¬Ø¹';
      const t=document.createElement('div'); t.className='toast'; t.textContent='ØªÙ… Ø§Ù„Ø­Ø°Ù '; t.appendChild(undo); $('#toasts').appendChild(t);
      const timer=setTimeout(()=>t.remove(),4000);
      undo.onclick=()=>{ clearTimeout(timer); t.remove(); events=backup; save(KEY_EVENTS,events); renderEvents(); toast('ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ âœ”ï¸','ok'); };
    };
    eT.appendChild(tr);
  }
}
function editEvent(it){
  eF.title_ar.value=it.title.ar; eF.title_en.value=it.title.en;
  eF.start.value=toLocal(it.startDate);
  const dur=((new Date(it.endDate)-new Date(it.startDate))/3600e3);
  eF.dur.value = isFinite(dur)&&dur>0 ? dur : 2;
  eF.loc.value=it.location||''; eF.url.value=it.url||'';
  eF.tags.value=(it.tags||[]).join(', '); eF.image.value=it.image||'';
  eF.img_prev.src = it.image||''; eF.img_prev.hidden=!it.image;
  eEditId.value=it.id; eSubmit.textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  window.scrollTo({top:0,behavior:'smooth'});
}
function clearForm(which){
  if(which==='events'){
    eForm.reset(); eEditId.value=''; eSubmit.textContent='â• Ø£Ø¶Ù ÙØ¹Ø§Ù„ÙŠØ©';
    if(eF.img_prev){ eF.img_prev.removeAttribute('src'); eF.img_prev.hidden = true; }
    localStorage.removeItem(DRAFT_EVENTS);
  } else if(which==='news') {
    // handled above
  }
}

/* ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±/Ù†Ø³Ø® ===== */
$('#export-news').onclick=()=> downloadJSON(news,'news.json');
$('#export-events').onclick=()=> downloadJSON(events,'events.json');
$('#import-news').onclick=()=> pickJSON(arr=>{ if(Array.isArray(arr)){ news=arr; save(KEY_NEWS,news); renderNews(); toast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± âœ”ï¸','ok'); } else toast('ÙŠÙØªÙˆÙ‚Ø¹ Ù…ØµÙÙˆÙØ© JSON','err');});
$('#import-events').onclick=()=> pickJSON(arr=>{ if(Array.isArray(arr)){ events=arr; save(KEY_EVENTS,events); renderEvents(); toast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª âœ”ï¸','ok'); } else toast('ÙŠÙØªÙˆÙ‚Ø¹ Ù…ØµÙÙˆÙØ© JSON','err');});
$('#n_copy').onclick=()=> copy(JSON.stringify(news,null,2));
$('#e_copy').onclick=()=> copy(JSON.stringify(events,null,2));
function pickJSON(cb){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; const t=await f.text(); try{ cb(JSON.parse(t)); }catch{ toast('JSON ØºÙŠØ± ØµØ§Ù„Ø­','err'); } };
  inp.click();
}

/* ===== Ù…Ø³ÙˆØ¯Ù‘Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ===== */
function saveDraft(which){
  const key = which==='news' ? DRAFT_NEWS : DRAFT_EVENTS;
  const obj = which==='news' ? {
    title_ar:nF.title_ar.value, title_en:nF.title_en.value,
    desc_ar:nF.desc_ar.value, desc_en:nF.desc_en.value,
    date:nF.date.value, image:nF.image.value, url:nF.url.value, tags:nF.tags.value
  } : {
    title_ar:eF.title_ar.value, title_en:eF.title_en.value,
    start:eF.start.value, dur:eF.dur.value, loc:eF.loc.value,
    url:eF.url.value, tags:eF.tags.value, image:eF.image.value
  };
  save(key, obj);
}
(function restoreDrafts(){
  const nd = load(DRAFT_NEWS); if(nd){
    nF.title_ar.value=nd.title_ar||''; nF.title_en.value=nd.title_en||'';
    nF.desc_ar.value=nd.desc_ar||''; nF.desc_en.value=nd.desc_en||'';
    nF.date.value=nd.date||''; nF.image.value=nd.image||''; nF.url.value=nd.url||''; nF.tags.value=nd.tags||'';
    nF.len_ar.textContent=nF.title_ar.value.length; nF.len_en.textContent=nF.title_en.value.length;
    nF.desc_ar_len.textContent=nF.desc_ar.value.length; nF.desc_en_len.textContent=nF.desc_en.value.length;
    if(nd.image){ nF.img_prev.src=nd.image; nF.img_prev.hidden=false; }
  }
  const ed = load(DRAFT_EVENTS); if(ed){
    eF.title_ar.value=ed.title_ar||''; eF.title_en.value=ed.title_en||'';
    eF.start.value=ed.start||''; eF.dur.value=ed.dur||2; eF.loc.value=ed.loc||'';
    eF.url.value=ed.url||''; eF.tags.value=ed.tags||''; eF.image.value=ed.image||'';
    if(ed.image){ eF.img_prev.src=ed.image; eF.img_prev.hidden=false; }
  }
})();

/* ===== Ø­ÙØ¸ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±Ø¨Ø·) ===== */
async function saveToRepo(path, content){
  if(!API_URL){ toast('Ø§Ø±Ø¨Ø· API_URL Ø£ÙˆÙ„Ù‹Ø§', 'err'); throw new Error('No API_URL'); }
  const btn = path.includes('news') ? $('#save-news-remote') : $('#save-events-remote');
  btn.disabled = true; const sp=document.createElement('span'); sp.className='spinner'; btn.appendChild(sp);
  try{
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ path, content, message: `update ${path} via admin` })
    });
    if(!res.ok){ const t=await res.text(); throw new Error(t); }
    const out = await res.json();
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ âœ”ï¸','ok');
    return out;
  } catch(e){
    toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹','err'); console.error(e);
    throw e;
  } finally {
    btn.disabled=false; sp.remove();
  }
}
$('#save-news-remote').onclick=()=> saveToRepo('data/news.json', news).catch(()=>{});
$('#save-events-remote').onclick=()=> saveToRepo('data/events.json', events).catch(()=>{});

/* ===== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ===== */
renderNews();
renderEvents();
</script>
</body>
</html>
