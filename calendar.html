<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>التقويم – Khotwa</title>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/design-system.css">
  <link rel="stylesheet" href="/assets/khotwa-redesign.css">
  <link rel="stylesheet" href="/assets/enhanced-navbar.css">
  
  <script src="/assets/khotwa-api.js?v=1766975537"></script>

  <style>
    /* تنسيق الجدول المرتب كما في صورتك السابقة */
    .events-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .event-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 1.2rem; 
      border-bottom: 1px solid #eee; 
      transition: background 0.2s;
    }
    .event-row:hover { background-color: #f9f9f9; }
    .event-main { display: flex; flex: 1; justify-content: flex-end; align-items: center; gap: 30px; }
    .event-title { font-weight: 600; color: #333; font-size: 1.05rem; text-align: right; }
    .event-date { color: #5c6bc0; font-weight: bold; min-width: 150px; text-align: right; white-space: nowrap; }
    .event-link { color: #6366f1; text-decoration: none; font-size: 0.9rem; font-weight: 500; }
    
    /* إصلاح مظهر الناف بار ليطابق الهيكل الجديد */
    .nav-links[data-open="true"] { display: flex !important; }
    [hidden] { display: none !important; }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="container nav-inner">
      <a class="brand" href="/index.html">
        <img src="/assets/apple-touch-icon.png" class="logo" alt="Logo">
        <span data-lang="ar">مجلس طلاب خطوة</span>
        <span data-lang="en" hidden>Khotwa Student Council</span>
      </a>

      <button id="menu-toggle" class="menu-toggle" aria-expanded="false">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>

      <div class="nav-links" id="primary-nav" data-open="false">
        <a href="/index.html"><span data-lang="ar">الرئيسية</span><span data-lang="en" hidden>Home</span></a>
        <a href="/news.html"><span data-lang="ar">الأخبار</span><span data-lang="en" hidden>News</span></a>
        <a href="/events.html"><span data-lang="ar">الفعاليات</span><span data-lang="en" hidden>Events</span></a>
        <a href="/calendar.html" class="active"><span data-lang="ar">التقويم</span><span data-lang="en" hidden>Calendar</span></a>
        <a href="/contact.html"><span data-lang="ar">اتصل بنا</span><span data-lang="en" hidden>Contact</span></a>
        
        <button class="lang-toggle" id="lang-toggle">
          <span data-lang="ar">English</span><span data-lang="en" hidden>عربي</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="container" id="main" style="margin-top: 40px;">
    <div style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 10px;">
        <span data-lang="ar">تقويم الفعاليات</span>
        <span data-lang="en" hidden>Events Calendar</span>
      </h1>
      <p class="muted">
        <span data-lang="ar">جدول الفعاليات القادمة لطلاب خطوة.</span>
        <span data-lang="en" hidden>Upcoming events schedule for Khotwa students.</span>
      </p>
    </div>

    <div class="card">
      <div id="events-list">
        <div style="padding: 2rem; text-align: center;">جاري تحميل التقويم...</div>
      </div>
    </div>
  </main>

  <script>
    // نظام تبديل اللغة
    function setLanguage(lang) {
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      
      document.querySelectorAll('[data-lang]').forEach(el => {
        const match = el.getAttribute('data-lang') === lang;
        el.hidden = !match;
        if (match) el.removeAttribute('aria-hidden');
        else el.setAttribute('aria-hidden', 'true');
      });
      localStorage.setItem('khotwa_lang', lang);
      loadCalendar(lang);
    }

    // دالة جلب البيانات ومعالجة مشكلة "Invalid Date"
    async function loadCalendar(lang) {
      const list = document.getElementById('events-list');
      try {
        const data = await KhotwaAPI.getEvents();
        if (!data || data.length === 0) {
          list.innerHTML = `<p style="padding: 2rem; text-align: center;">${lang === 'ar' ? 'لا توجد فعاليات حالياً.' : 'No events available.'}</p>`;
          return;
        }

        list.innerHTML = data.map(ev => {
          // معالجة التاريخ لضمان عدم ظهور Invalid Date
          const rawDate = ev.date || ev.eventDate || ev.createdAt;
          const dateObj = new Date(rawDate);
          
          let formattedDate = "";
          if (!isNaN(dateObj.getTime())) {
            formattedDate = dateObj.toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-AU', {
              day: 'numeric', month: 'long', year: 'numeric'
            });
          } else {
            formattedDate = rawDate; // عرض النص الخام إذا فشل التحويل
          }

          const title = lang === 'ar' ? (ev.titleAr || ev.title) : (ev.titleEn || ev.title);

          return `
            <div class="event-row">
              <a href="/event-detail.html?id=${ev.id}" class="event-link">${lang === 'ar' ? 'التفاصيل' : 'Details'}</a>
              <div class="event-main">
                <span class="event-title">${title}</span>
                <span class="event-date">${formattedDate}</span>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        list.innerHTML = '<p style="padding: 2rem; text-align: center;">حدث خطأ أثناء تحميل البيانات.</p>';
      }
    }

    // التشغيل عند التحميل
    document.addEventListener('DOMContentLoaded', () => {
      const savedLang = localStorage.getItem('khotwa_lang') || 'ar';
      setLanguage(savedLang);

      document.getElementById('lang-toggle').addEventListener('click', () => {
        const current = localStorage.getItem('khotwa_lang') === 'ar' ? 'en' : 'ar';
        setLanguage(current);
      });
    });
  </script>

  <script src="/js/menu-toggle.js"></script>
  <script src="/assets/site-settings-loader.js"></script>
</body>
</html>
