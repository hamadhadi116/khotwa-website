<!-- qr-scanner.html -->
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù…Ø³Ø­ QR Ù„Ù„Ø­Ø¶ÙˆØ± â€“ Khotwa</title>
  <meta name="description" content="Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ ÙÙŠ ÙØ¹Ø§Ù„ÙŠØ§Øª Ù…Ø¬Ù„Ø³ Ø·Ù„Ø§Ø¨ Ø®Ø·ÙˆØ©.">
  <link rel="canonical" href="https://khotwastudentcouncil.com/qr-scanner.html"/>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="color-scheme" content="light dark"/>
  
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

  <style>
    :root {
      --primary:#1e40af; --primary-600:#1d4ed8; --text:#0f172a; --muted:#64748b;
      --surface:#ffffff; --card:#f8fafc; --ring:#e6eaf2; --success:#10b981; --error:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Segoe UI",system-ui,-apple-system,Tahoma,Arial,sans-serif;
      color:var(--text);
      background:var(--surface);
      line-height:1.6;
      display:flex;
      flex-direction:column;
    }
    .container{width:min(600px,92%);margin-inline:auto;padding:2rem 0}
    
    header{
      text-align:center;
      margin-bottom:2rem;
    }
    h1{
      font-size:1.8rem;
      margin-bottom:.5rem;
      color:var(--primary);
    }
    .subtitle{
      color:var(--muted);
      font-size:.95rem;
    }
    
    .card{
      background:#fff;
      border:1px solid var(--ring);
      border-radius:16px;
      padding:1.5rem;
      box-shadow:0 2px 10px rgba(2,6,23,.06);
      margin-bottom:1.5rem;
    }
    
    #reader{
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:#000;
      margin-bottom:1rem;
    }
    
    .form-group{
      margin-bottom:1rem;
    }
    .form-group label{
      display:block;
      margin-bottom:.4rem;
      font-weight:600;
      color:var(--text);
    }
    .form-group input{
      width:100%;
      padding:.7rem;
      border:1px solid var(--ring);
      border-radius:8px;
      font-size:.95rem;
      font-family:inherit;
    }
    .form-group input:focus{
      outline:2px solid var(--primary);
      outline-offset:2px;
    }
    
    .btn{
      width:100%;
      padding:.8rem;
      border:none;
      border-radius:8px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:.2s;
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
    }
    .btn-primary:hover{
      background:var(--primary-600);
    }
    .btn-primary:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    
    .alert{
      padding:1rem;
      border-radius:8px;
      margin-bottom:1rem;
      display:none;
    }
    .alert.show{
      display:block;
    }
    .alert-success{
      background:#d1fae5;
      color:#065f46;
      border:1px solid #10b981;
    }
    .alert-error{
      background:#fee2e2;
      color:#991b1b;
      border:1px solid #ef4444;
    }
    .alert-info{
      background:#dbeafe;
      color:#1e40af;
      border:1px solid #3b82f6;
    }
    
    .status{
      text-align:center;
      padding:1rem;
      color:var(--muted);
      font-size:.9rem;
    }
    
    #visitor-form{
      display:none;
    }
    #visitor-form.show{
      display:block;
    }
    
    .back-link{
      display:inline-block;
      margin-top:1rem;
      color:var(--primary);
      text-decoration:none;
    }
    .back-link:hover{
      text-decoration:underline;
    }
  </style>
  <link rel="stylesheet" href="/assets/feedback.css">
  <link rel="stylesheet" href="/assets/design-system.css">
  <link rel="stylesheet" href="/assets/khotwa-redesign.css">
    <link rel="stylesheet" href="assets/enhanced-navbar.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar" style="position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--ring);z-index:40;padding:0.8rem 0">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between">
      <a href="/index.html" style="display:flex;align-items:center;gap:0.6rem;font-weight:700;text-decoration:none;color:inherit">
        <img src="/assets/apple-touch-icon.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø¬Ù„Ø³ Ø·Ù„Ø§Ø¨ Ø®Ø·ÙˆØ©" width="40" height="40" style="border-radius:8px">
        <span>Ù…Ø¬Ù„Ø³ Ø·Ù„Ø§Ø¨ Ø®Ø·ÙˆØ©</span>
      </a>
      <a href="/index.html" style="color:var(--primary);text-decoration:none">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
  </nav>

  <div class="container">
    <header>
      <h1>ğŸ« Ù…Ø³Ø­ QR Ù„Ù„Ø­Ø¶ÙˆØ±</h1>
      <p class="subtitle">Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</p>
    </header>

    <div class="alert" id="alert"></div>

    <div class="card">
      <div id="reader"></div>
      <div class="status" id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
    </div>

    <div class="card" id="visitor-form">
      <h2 style="margin-bottom:1rem">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
      <form id="checkin-form">
        <input type="hidden" id="event-id" name="eventId">
        
        <div class="form-group">
          <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
          <input type="text" id="name" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
          <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
          <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
          <input type="tel" id="phone" name="phone" required>
        </div>
        
        <button type="submit" class="btn btn-primary" id="submit-btn">
          âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±
        </button>
      </form>
    </div>

    <div style="text-align:center">
      <a href="/events.html" class="back-link">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</a>
    </div>
  </div>

  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  
  <!-- KhotwaAPI -->
  <script src="/assets/khotwa-api.js"></script>

  <script>
    (function(){
      const readerEl = document.getElementById('reader');
      const statusEl = document.getElementById('status');
      const alertEl = document.getElementById('alert');
      const visitorForm = document.getElementById('visitor-form');
      const checkinForm = document.getElementById('checkin-form');
      const eventIdInput = document.getElementById('event-id');
      const submitBtn = document.getElementById('submit-btn');
      
      let html5QrCode;
      let scannedEventId = null;
      let isProcessing = false;

      function showAlert(message, type = 'info') {
        alertEl.textContent = message;
        alertEl.className = `alert alert-${type} show`;
        setTimeout(() => {
          alertEl.classList.remove('show');
        }, 5000);
      }

      function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing) return;
        isProcessing = true;

        try {
          // Parse QR code data
          const data = JSON.parse(decodedText);
          
          if (data.type !== 'event_checkin') {
            showAlert('Ø±Ù…Ø² QR ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ù…Ø³Ø­ Ø±Ù…Ø² Ø®Ø§Øµ Ø¨Ø§Ù„Ø­Ø¶ÙˆØ±.', 'error');
            isProcessing = false;
            return;
          }

          scannedEventId = data.eventId;
          eventIdInput.value = scannedEventId;
          
          // Stop scanning
          html5QrCode.stop().then(() => {
            statusEl.textContent = 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­! âœ…';
            showAlert('ØªÙ… Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ.', 'success');
            visitorForm.classList.add('show');
          });

        } catch (err) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© QR:', err);
          showAlert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø±Ù…Ø² QR. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
          isProcessing = false;
        }
      }

      function onScanError(errorMessage) {
        // Ignore scan errors (they happen frequently)
      }

      // Initialize QR scanner
      function initScanner() {
        html5QrCode = new Html5Qrcode("reader");
        
        Html5Qrcode.getCameras().then(cameras => {
          if (cameras && cameras.length) {
            statusEl.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­ ğŸ“·';
            
            // Start scanning with back camera if available
            const cameraId = cameras.length > 1 ? cameras[1].id : cameras[0].id;
            
            html5QrCode.start(
              cameraId,
              {
                fps: 10,
                qrbox: { width: 250, height: 250 }
              },
              onScanSuccess,
              onScanError
            ).catch(err => {
              console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­:', err);
              statusEl.textContent = 'ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
              showAlert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.', 'error');
            });
          } else {
            statusEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§';
            showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².', 'error');
          }
        }).catch(err => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª:', err);
          statusEl.textContent = 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
          showAlert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.', 'error');
        });
      }

      // Handle form submission
      checkinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!scannedEventId) {
          showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø£ÙˆÙ„Ø§Ù‹.', 'error');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

        try {
          const formData = new FormData(checkinForm);
          const data = {
            eventId: parseInt(scannedEventId),
            name: formData.get('name'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            visitorId: `visitor_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
          };

          // Call attendance check-in API
          const response = await fetch(KhotwaAPI.API_BASE_URL + '/attendance.checkIn', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (result.success || response.ok) {
            showAlert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ.', 'success');
            checkinForm.reset();
            visitorForm.classList.remove('show');
            
            // Restart scanning after 3 seconds
            setTimeout(() => {
              scannedEventId = null;
              isProcessing = false;
              initScanner();
            }, 3000);
          } else {
            throw new Error(result.error?.message || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±');
          }

        } catch (err) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±:', err);
          showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±';
        }
      });

      // Initialize on page load
      initScanner();
    })();
  </script>
<script src="/assets/feedback.js"></script>
  <script src="/assets/admin-button.js"></script>
  <script src="/assets/feedback-button.js"></script>
    <script src="js/settings-loader.js"></script>
</body>
</html>
