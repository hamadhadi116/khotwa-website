<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>الأخبار – Khotwa</title>

  <meta name="description" content="آخر أخبار وإعلانات مجلس طلاب خطوة في ملبورن.">
  <link rel="canonical" href="https://khotwastudentcouncil.com/news.html"/>
  <meta name="robots" content="index,follow"/>
  <meta name="color-scheme" content="light dark"/>

  <!-- CSS (كما كان) -->
  <link rel="stylesheet" href="/assets/feedback.css">
  <link rel="stylesheet" href="/assets/comments-and-registration.css"/>
  <link rel="stylesheet" href="/assets/pagination.css">
  <link rel="stylesheet" href="/assets/advanced-filters.css">

  <!-- API -->
  <script src="/assets/khotwa-api.js"></script>
</head>

<body>

<main class="container" id="main">
  <section>
    <h1 data-lang="ar">الأخبار</h1>
    <h1 data-lang="en" hidden>News</h1>

    <p class="muted" data-lang="ar">
      كل جديد عن مجلس طلاب خطوة: إعلانات، مبادرات، وتغطيات.
    </p>
    <p class="muted" data-lang="en" hidden>
      Latest announcements and updates from Khotwa Student Council.
    </p>

    <!-- أدوات البحث -->
    <div class="tools">
      <div class="search" role="search">
        <input id="q" type="search" placeholder="ابحث في الأخبار…" aria-label="بحث">
      </div>

      <button class="chip" data-filter="all" data-active="true">الكل</button>
      <button class="chip" data-filter="ann">إعلانات</button>
      <button class="chip" data-filter="event">فعاليات</button>
      <button class="chip" data-filter="media">تغطيات</button>
    </div>
  </section>

  <!-- الأخبار -->
  <section aria-live="polite">
    <div class="grid grid-3" id="posts">
      <div class="muted">جارٍ تحميل الأخبار…</div>
    </div>
  </section>
</main>

<script>
(function () {
  if (!window.KhotwaAPI) {
    console.error('❌ KhotwaAPI غير محمّل');
    return;
  }

  const postsEl = document.getElementById('posts');
  const qInput = document.getElementById('q');
  const chips = Array.from(document.querySelectorAll('.chip'));

  let currentQuery = '';
  let currentCategory = 'all';

  async function loadNews() {
    postsEl.innerHTML = '<div class="muted">جارٍ التحميل…</div>';

    try {
      let items;

      if (currentQuery || currentCategory !== 'all') {
        items = await KhotwaAPI.searchNews(
          currentQuery,
          currentCategory === 'all' ? null : currentCategory,
          'newest'
        );
      } else {
        items = await KhotwaAPI.getNews();
      }

      postsEl.innerHTML = '';

      if (!items || items.length === 0) {
        postsEl.innerHTML = '<div class="muted">لا توجد أخبار حالياً.</div>';
        return;
      }

      items.forEach((item, idx) => {
        const article = document.createElement('article');
        article.className = 'post';
        article.id = 'post-' + (idx + 1);

        article.innerHTML = `
          ${item.image ? `<img src="${item.image}" alt="${item.title}">` : ''}
          <div class="body">
            <h3>${item.title}</h3>
            <p class="muted">${item.content?.substring(0,150) || ''}...</p>
          </div>
        `;

        postsEl.appendChild(article);
      });

    } catch (err) {
      console.error('❌ خطأ تحميل الأخبار:', err);
      postsEl.innerHTML = '<div class="muted">تعذر تحميل الأخبار.</div>';
    }
  }

  // البحث
  qInput?.addEventListener('input', (e) => {
    currentQuery = e.target.value.trim();
    loadNews();
  });

  // الفلاتر
  chips.forEach(btn => {
    btn.addEventListener('click', () => {
      chips.forEach(b => b.dataset.active = 'false');
      btn.dataset.active = 'true';
      currentCategory = btn.dataset.filter;
      loadNews();
    });
  });

  loadNews();
})();
</script>

</body>
</html>
